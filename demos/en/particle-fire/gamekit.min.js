/* Gamekit
 * =======
 * @license: CC BY-NC 3.0 (http://creativecommons.org/licenses/by-nc/3.0/)
 * @license: Request commercial licenses from hello@wearekiss.com
 * @author: Christian Engel <hello@wearekiss.com>
 * @updated: Fri Apr 17 2015
 */
!function(){"use strict";function a(a){this.entities=[],this.visible=!0,this.alpha=1,this._core=a}function b(a,b){for(b-=90;0>b;)b+=360;for(;b>360;)b-=360;var c,d;return c=a*Math.cos(b*Math.PI/180),d=a*Math.sin(b*Math.PI/180),[c,d]}function c(a,b){var c,d;return d=57.29577951308232*Math.atan2(a,b),c=Math.sqrt(a*a+b*b),[c,d]}function d(){function a(a,b){var c,d,e;if(c=q[a.keyCode],c&&(e=p[c],p[c]=b,void 0!==o[c]))for(d in o[c])b?e||o[c][d].resolve():e&&o[c][d].reject()}m||(o={},p={},window.onkeydown=function(b){a(b,!0)},window.onkeyup=function(b){a(b,!1)},m=!0)}function e(a){var b,c;c=a.getCanvas(),n||(n=!0,b=document.createElement("canvas"),b.width=c.width,b.height=c.height,r=b.getContext("2d"),r.globalCompositeOperation="copy",r.fillStyle="#f00",h.pointers=[],c.onmousedown=function(b){s&&f(a,b,"pointerdown")},c.onmouseup=function(b){t&&f(a,b,"pointerup")},c.onmousemove=function(b){u&&f(a,b,"pointermove")},c.ontouchstart=function(b){s&&f(a,b,"pointerdown")},c.ontouchend=function(b){t&&f(a,b,"pointerdown")},c.ontouchmove=function(b){u&&f(a,b,"pointermove")})}function f(a,b,c){var d,e,f,g,i,j,k,l,m;if(m=a.getCanvas(),d=b.clientX-m.offsetLeft+window.scrollX,e=b.clientY-m.offsetTop+window.scrollY,h.pointers.length||h.pointers.push({x:0,y:0}),h.pointers[0].x=d,h.pointers[0].y=e,a.isRunning)for(f=h.layer.length-1,k=f+1;k--;)if(g=h.layer[f-k],g.visible)for(i=g.entities.length-1,j=i+1;j--;)l=g.entities[i-j],l.disabled||void 0===l.shadowDraw||l.shadowDraw(d,e,c)}function g(a,b){var c;return c=r.getImageData(a,b,1,1).data,!!(c[0]||c[1]||c[2]||c[3])}var h;!function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),window.gamekit=h={},h.Core=function(){function a(d){var q,r,s,t,u;if(t=f.layer,b){for(k++,d-1e3>l&&(j=k,k=0,l=d),window.requestAnimationFrame(a),f.lastRunTime=c=d,g(e),(o||p)&&e.clearRect(m,n,o,p),q=i.length;q--;)r=i[q],r.finished?i.splice(q,1):r.update(d);for(u=t.length-1,q=u+1;q--;)s=t[u-q],s.visible&&s.alpha&&s.draw(e);h(e)}}var b,c,d,e,f,g,h,i,j,k,l;f=this,d=document.getElementsByTagName("canvas"),d.length?(d=d[0],e=d.getContext("2d")):(d=null,e=null),i=[],j=0,k=0,l=0,this.isRunning=!1,this.layer=[],this.getLastRuntime=function(){return c},this.useCanvas=function(a){return"string"==typeof a?("#"===a[0]&&(a=a.substr(1)),d=document.getElementById(a),e=d.getContext("2d"),this):(d=a,e=d.getContext("2d"),this)},this.start=function(){return this.isRunning=b=!0,window.requestAnimationFrame(a),this},this.stop=function(){return this.isRunning=b=!1,this},this.width=function(a){return a&&(d.width=a),d.width},this.height=function(a){return a&&(d.height=a),d.height},this.addTween=function(a){i.push(a)},this.camera={x:0,y:0},g=function(){},this.setOnBeforeFrame=function(a){return g=a,this},h=function(){},this.setOnAfterFrame=function(a){return h=a,this};var m,n,o,p;this.clearCanvas=function(a,b,c,d){return m=a||0,n=b||0,o=c||this.width(),p=d||this.height(),this},this.getCanvas=function(){return d},this.getCTX=function(){return e},this.getFPS=function(){return j}},h.Promise=function(a){this._promiseTarget=a||h},h.Promise.prototype={resolve:function(){var a,b;return"function"==typeof this._promiseSuccess?(a=this._promiseSuccess.apply(this._promiseTarget,arguments),a instanceof h.Promise?(b=this,a.then(function(){b._promiseChild.resolve.apply(b._promiseChild,arguments)},function(){b._promiseChild.reject.apply(b._promiseChild,arguments)})):this._promiseChild.resolve.apply(this._promiseChild,a),void 0):(this._promiseResolved=arguments,void 0)},reject:function(){var a,b;return"function"==typeof this._promiseError?(a=this._promiseError.apply(this._promiseTarget,arguments),a instanceof h.Promise?(b=this,a.then(function(){b._promiseChild.resolve.apply(b._promiseChild,arguments)},function(){b._promiseChild.reject.apply(b._promiseChild,arguments)})):this._promiseChild.reject.apply(this._promiseChild,a),void 0):(this._promiseRejected=arguments,void 0)},progress:function(){"function"==typeof this._promiseProgress&&this._promiseProgress.apply(this._promiseTarget,arguments)},then:function(a,b,c){return this._promiseSuccess=a,this._promiseError=b,this._promiseProgress=c,this._promiseChild=new h.Promise(this._promiseTarget),void 0!==this._promiseResolved&&this.resolve.apply(this,this._promiseResolved),void 0!==this._promiseRejected&&this.reject.apply(this,this._promiseRejected),this._promiseChild}},h.all=h.Promise.all=function(){function a(){c++,c===arguments.length&&b.resolve()}var b,c,d;for(b=new h.Promise,c=0,d=0;d<arguments.length;d++)arguments[d].then(a,b.reject);return b},h.chain=h.Promise.chain=function(){var a;return a=arguments,function(){function b(){var e;return c>=a.length?(d.resolve(),void 0):(e=a[c](),c++,e instanceof h.Promise?(e.then(function(){b()}),void 0):(b(),void 0))}var c,d;return c=0,d=new h.Promise,b(),d}},h.parallel=h.Promise.parallel=function(){var a;return a=arguments,function(){function b(){return e--,0===e?(f.resolve(),void 0):void 0}function c(){var e;d>=a.length||(e=a[d](),d++,e instanceof h.Promise?e.then(b):b(),c())}var d,e,f;return d=0,f=new h.Promise,e=a.length,c(),f}},h.wait=h.Promise.wait=function(a){return function(){var b,c,d,e;return b=new h.Promise,d=lastRunTime,e=d+a,c={finished:!1,update:function(f){void 0===d&&(d=f,e=d+a),f>=e&&(c.finished=!0,b.resolve())}},i.push(c),b}},h.m={},h.moduleFolder="lib/game/",h.defineModule=function(a,b){h.m[a]="function"==typeof b?b():b,h.m[a]instanceof h.Promise&&h.m[a].then(function(b,c){h.m[a]=c})},h.fetchModules=function(a){function b(){g++,g===f.length&&e.resolve()}function c(){e.reject()}var d,e,f,g,i;e=new h.Promise,f=[],g=0,"string"==typeof a&&(a=[a]);for(d in a)void 0===h.m[a[d]]&&f.push(h.moduleFolder+a[d]+".js");if(f.length)for(d in f)i=document.createElement("script"),i.onload=b,i.onerror=c,document.head.appendChild(i),i.src=f[d],f[d]=i;else e.resolve();return e},h.limitCalls=function(a,b){var c;return c=0,function(){Date.now()<c+b||(c=Date.now(),a.apply(this,arguments))}},h.clone=function(a){if(null===a||"object"!=typeof a)return a;var b,c,d,e;for(a instanceof h.Sprite&&(b=new h.Sprite(a.asset)),a instanceof h.Group&&(b=new h.Group),void 0===b&&(b={}),c=Object.keys(a),d=0;d<c.length;d++)e=a[c[d]],b[c[d]]=e instanceof h.Group||e instanceof h.Sprite?h.clone(e):e;return b},h.Timer=function(a,b){var c,d,e;return b||(b=h),c=new h.Promise,c.interval=a,d={finished:!1,update:function(a){return e?(e+c.interval<a&&(e=a,c.resolve()),void 0):(e=a,void 0)}},c.disable=function(){d.finished=!0},c.enable=function(){d.finished=!1,b.addTween(d)},c.enable(),c},h.randomSeed=function(){return Math.floor(99999*Math.random())+1}(),h.random=function(){var a=1e4*Math.abs(Math.sin(h.randomSeed++));return a-~~a},h.randomInRange=function(a,b){return a===b?a:h.random()*(b-a)+a},h.ifDef=function(a,b){return void 0!==a?a:b},h.extend=function(a){var b,c,d=1;if(1===arguments.length)return a;for(;d<arguments.length;d++)if(b=arguments[d])for(c in b)a[c]=b[c];return a},h.a={},h.assetFolder="lib/assets/",h.getJSON=function(a){var b,c;return b=new h.Promise,c=new XMLHttpRequest,c.onload=function(){var a;try{a=JSON.parse(c.responseText),b.resolve(a)}catch(d){b.reject(d)}},c.onerror=b.reject,c.open("get",a,!0),c.send(),b},h.loadAssets=function(a){function b(){var a,b;return(a=this.src.match(j))?(h.a[this.assetKey]=new h.SpriteMap({image:h.a[this.assetKey],tileW:parseInt(a[1],10),tileH:parseInt(a[2],10)}),g++,g===f.length&&d.resolve(),void 0):(a=this.src.match(k))?(a=this.src.split("."),a.pop(),a=a.join(".")+".json",b=this,h.getJSON(a).then(function(a){h.a[b.assetKey]=new h.SpriteAtlas(h.a[b.assetKey],a),g++,g===f.length&&d.resolve()}),void 0):(g++,g===f.length&&d.resolve(),void 0)}function c(){d.reject()}var d,e,f,g,i,j,k,l;if(d=new h.Promise,f=[],g=0,j=/\.smap\.(\d+)x(\d+)\./,k=/\.atlas\./,"string"==typeof a){if(l=a.split(":"),1===l.length&&(l=l[0].split(".")),void 0!==h.a[l[0]])return d.resolve(h.a[l[0]]),d;if(".json"===a.substr(-5))return a=a.split(":"),h.getJSON(h.assetFolder+a.pop()).then(function(b){if(a.length){if(h.a[a[0]]=b,b.tilesets){var c,f,g=[];for(f=new h.Promise,e=0;e<b.tilesets.length;e++)c=b.tilesets[e].image.split("."),c.pop(),c=c.join("."),b.tilesets[e].key="tileset_"+c,g.push("tileset_"+c+":"+b.tilesets[e].image);return h.loadAssets(g).then(function(){for(e=0;e<b.tilesets.length;e++)h.a[b.tilesets[e].key]=new h.SpriteMap({image:h.a[b.tilesets[e].key],tileW:b.tilesets[e].tilewidth,tileH:b.tilesets[e].tileheight,offsX:b.tilesets[e].margin,offsY:b.tilesets[e].margin,spacingX:b.tilesets[e].spacing,spacingY:b.tilesets[e].spacing});f.resolve()},function(){f.reject()}),f}return d.resolve(),d}return h.loadAssets(b)}).then(function(){d.resolve()},function(){d.reject()}),d;a=[a]}for(e=0;e<a.length;e++)a[e]=a[e].split(":"),2!==a[e].length&&a[e].unshift(a[e][0].split(".").shift()),void 0===h.a[a[e][0]]&&(i=new Image,i.onload=b,i.onerror=c,i.assetKey=a[e][0],h.a[a[e][0]]=i,f.push(a[e]));if(f.length)for(e=0;e<f.length;e++)h.a[f[e][0]].src=h.assetFolder+f[e][1];else d.resolve();return d},h.SpriteMap=function(a){var b=[];a.offsX=a.offsX||0,a.offsY=a.offsY||0,a.spacingX=a.spacingX||0,a.spacingY=a.spacingY||0,b._image=a.image,b._tileW=a.tileW,b._tileH=a.tileH,b._animations={},b._tilesOnXAxis=Math.floor((a.image.width-a.offsX)/(a.tileW+a.spacingX)),b._tilesOnYAxis=Math.floor((a.image.height-a.offsY)/(a.tileH+a.spacingY));for(var c=0;c<b._tilesOnYAxis;c++)for(var d=0;d<b._tilesOnXAxis;d++)b.push({image:b._image,x:d*a.tileW+a.offsX+d*a.spacingX,y:c*a.tileH+a.offsY+c*a.spacingY,w:a.tileW,h:a.tileH});return b._isSpritemap=!0,h.extend(b,h.SpriteMap.prototype),b},h.SpriteMap.prototype={createAnimation:function(a,b,c,d,e){for(var f={key:a,loop:d===!0,fps:e||h.SpriteMap.defaultFPS,frames:c?[]:b},g=b;c>=g;g++)f.frames.push(g);this._animations[a]=f}},h.SpriteMap.defaultFPS=25,h.SpriteAtlas=function(a,b){var c={};c._image=a,c.keys=[];for(var d in b)c.keys.push(d),c[d]=void 0!==b[d].x?{image:a,x:b[d].x,y:b[d].y,w:b[d].w,h:b[d].h}:{image:a,x:b[d][0],y:b[d][1],w:b[d][2],h:b[d][3]};return c._isSpriteAtlas=!0,h.extend(c,h.SpriteAtlas.prototype),c},h.SpriteAtlas.prototype={createAnimation:function(a,b,c,d){var e={key:a,loop:c===!0,fps:d||h.SpriteMap.defaultFPS,frames:b};this._animations[a]=e}},h.SpriteAtlas.defaultFPS=25,a.prototype={attach:function(a){a._core=this._core,this.entities.push(a)},detach:function(a){var b=this.entities.indexOf(a);b>=0&&this.entities.splice(b,1)},clear:function(){this.entities.length=0},draw:function(a){var b,c,d,e,f;for(e=this._core.camera.x,f=this._core.camera.y,b=this.entities.length-1,c=b+1;c--;)d=this.entities[b-c],d._destroy?(this.entities.splice(b-c,1),b--):d.alpha<0?d.alpha=0:(a.globalAlpha=d.alpha*this.alpha,d.update(),a.save(),a.translate(-e,-f),d.draw(a),a.restore())}},h.layer=[new a(h)],h.Core.prototype.createLayer=function(){var b;return b=new a(this),this.layer.push(b),b};var i;h.renderDebugObjects=!1,i=[],h.Sprite=function(a){this.x=0,this.y=0,this.originX=0,this.originY=0,this.rotation=0,this.direction=0,this._directionCache=null,this.speed=0,this.friction=0,this.scaleX=1,this.scaleY=1,this.alpha=1,this.stretch=!1,this.debugDrawing=!1,this._destroy=!1,this._core=h,this.setAsset(a)},h.Sprite.prototype={update:function(){},draw:function(a){var c,d,e,f,g,h,i,j;if(e=this.originX,f=this.originY,c=this.w,d=this.h,this._spritemap?(g=this._spritemap[this._spritemapIndex].x,h=this._spritemap[this._spritemapIndex].y,i=this._spritemap[this._spritemapIndex].w,j=this._spritemap[this._spritemapIndex].h):this._spriteatlas?(g=this._spriteatlas[this._spriteAtlasKey].x,h=this._spriteatlas[this._spriteAtlasKey].y,i=this._spriteatlas[this._spriteAtlasKey].w,j=this._spriteatlas[this._spriteAtlasKey].h):(g=this._assetDimensions.x,h=this._assetDimensions.y,i=this._assetDimensions.w,j=this._assetDimensions.h),a.save(),a.translate(this.x,this.y),this.alpha<0&&(this.alpha=0),a.globalAlpha=this.alpha,this.speed){for(;this.direction>360;)this.direction-=360;for(;this.direction<0;)this.direction+=360;this._directionCache&&this._directionCache[0]===this.speed&&this._directionCache[1]===this.direction||(this._directionCache=[this.speed,this.direction,b(this.speed,this.direction)]),this.x+=this._directionCache[2][0],this.y+=this._directionCache[2][1],this.speed>0?(this.speed-=this.friction,this.speed<0&&(this.speed=0)):(this.speed+=this.friction,this.speed>0&&(this.speed=0))}if(this.rotation){for(;this.rotation>360;)this.rotation-=360;for(;this.rotation<0;)this.rotation+=360;a.rotate(this.rotation*Math.PI/180)}return a.scale(this.scaleX,this.scaleY),this.stretch||c===i&&d===j?(a.drawImage(this.asset,g,h,i,j,-e,-f,c,d),this.debugDrawing&&(a.beginPath(),a.strokeStyle="#0ff",a.strokeRect(-e,-f,c,d),a.stroke(),a.fillStyle="#f0f",a.beginPath(),a.arc(0,0,2,0,365),a.fill()),a.restore(),void 0):(this.pattern||(this.pattern=a.createPattern(this.asset,"repeat")),a.fillStyle=this.pattern,a.fillRect(-e,-f,c,d),a.restore(),void 0)},centerOrigin:function(){return this.changeOrigin(this.w/2,this.h/2),this},changeOrigin:function(a,b){var c,d;return c=this.originX,d=this.originY,this.x+=-c+a,this.y+=-d+b,this.originX=a,this.originY=b,this},setAnimation:function(a){if(!this._spritemap)throw new Error("No spritemap set");if(!this._spritemap._animations[a])throw new Error("Unknown animation");var b,c,d,e,f,g,i,j;return this._animation=c={key:a,loop:this._spritemap._animations[a].loop,fps:this._spritemap._animations[a].fps,frames:this._spritemap._animations[a].frames},f=this,c.loop||(d=new h.Promise),b=this._core,j=b.getLastRuntime(),i=b.getFPS()?1e3/b.getFPS()*(b.getFPS()/c.fps):1e3/60*(60/c.fps),this._spritemapIndex=c.frames[0],g=1,e={finished:!1,update:function(h){if(f._animation.key!==a)return e.finished=!0,void 0;if(!(j+i>=h)){if(j=h,b.getFPS()&&(i=Math.min(1e3/b.getFPS()*(b.getFPS()/c.fps),1e3)),g++,g>=c.frames.length){if(!c.loop)return e.finished=!0,f._animation=null,d.resolve(),void 0;g=0}f._spritemapIndex=c.frames[g]}}},b.addTween(e),d},tween:function(a,b){var c,d,e,f,g,i,j,k,l,m,n;n=this._core||h,c=n.getLastRuntime(),d=c+b,f=new h.Promise(this),g=this,i={},j={},k=0;for(l in a)this.hasOwnProperty(l)&&("string"!=typeof a[l]?!isNaN(parseFloat(this[l]))&&isFinite(this[l])&&(i[l]=this[l],j[l]=a[l]-this[l],k++):(m=a[l].match(/^([+-])=(\d+)$/),m&&(i[l]=this[l],j[l]="+"===m[1]?parseFloat(m[2]):-parseFloat(m[2]),k++)));return k?(e={finished:!1,update:function(a){var h;void 0===c&&(c=a,d=c+b),h=1-1/((d-c)/(d-a)),h>=1&&(h=1);for(l in i)g[l]=i[l]+j[l]*h;f.progress(h),1===h&&(e.finished=!0,f.resolve())}},n.addTween(e),f):(f.reject(),f)},prepareTween:function(a,b){var c;return c=this,function(){return c.tween(a,b)}},destroy:function(){this._destroy=!0},setAsset:function(a){return a instanceof Image?(this.asset=a,this.w=a.width,this.h=a.height,this._assetDimensions={x:0,y:0,w:a.width,h:a.height},void 0):a._isSpritemap?(this.asset=a._image,this._spritemap=a,this._spritemapIndex=0,this.w=this._spritemap[0].w,this.h=this._spritemap[0].h,void 0):a._isSpriteAtlas?(this.asset=a._image,this._spriteatlas=a,this._spriteAtlasKey=a.keys[0],this.w=a[a.keys[0]].w,this.h=a[a.keys[0]].h,void 0):(this.asset=a.image,this.w=a.w,this.h=a.h,this._assetDimensions={x:a.x,y:a.y,w:a.w,h:a.h},void 0)},applyForce:function(a,d,e){var f,g,h,i;return this.speed?(f=b(d,a),h=this._directionCache?this._directionCache[2]:[0,0],void 0!==e&&(g=b(e,a),f[0]=g[0]<0?h[0]>g[0]?Math.max(g[0],h[0]+f[0]):0:h[0]<g[0]?Math.min(g[0],h[0]+f[0]):0,f[1]=g[1]<0?h[1]>g[0]?Math.max(g[1],h[1]+f[1]):0:h[1]<g[0]?Math.min(g[1],h[1]+f[1]):0),i=c(h[0]+f[0],h[1]+f[1]),this.speed=i[0],this.direction=i[1],this._directionCache=[i[0],i[1],[h[0]+f[0],h[1]+f[1]]],void 0):(this.direction=a,this.speed=d,void 0)}},h.Group=function(){this.x=0,this.y=0,this.rotation=0,this.alpha=1,this.scaleX=1,this.scaleY=1,this.entities=[],this.debugDrawing=!1,this._destroy=!1,this._core=h},h.Group.prototype={update:function(){},getBoundaries:function(){var a,b,c,d,e,f,g;if(a=Number.POSITIVE_INFINITY,b=Number.POSITIVE_INFINITY,c=0,d=0,!this.entities.length)return{x:this.x,y:this.y,w:0,h:0};for(f=this.entities.length-1,e=f+1;e--;)g=this.entities[f-e],g instanceof h.Sprite?void 0!==g.originX?(a=Math.min(a,g.x-g.originX),b=Math.min(b,g.y-g.originY),c=Math.max(c,g.x+g.w-g.originX),d=Math.max(d,g.y+g.h-g.originY)):(a=Math.min(a,g.x),b=Math.min(b,g.y),c=Math.max(c,g.x+g.w),d=Math.max(d,g.y+g.h)):g instanceof h.Group&&(g=g.getBoundaries(),a=Math.min(a,this.x-g.x),b=Math.min(b,this.y-g.y),c=Math.max(c,g.w),d=Math.max(d,g.h));return c-=a,d-=b,{x:a,y:b,w:c,h:d}},attach:function(a){this.entities.push(a)},draw:function(a){var b,c,d,e;for(a.save(),a.translate(this.x,this.y),a.rotate(this.rotation*Math.PI/180),a.scale(this.scaleX,this.scaleY),b=a.globalAlpha,d=this.entities.length-1,c=d+1;c--;)e=this.entities[d-c],e._destroy?(l.entities.splice(d-c,1),d--):(a.globalAlpha=b*e.alpha,e.update(),e.draw(a));if(this.debugDrawing){var f;f=this.getBoundaries(),a.beginPath(),a.strokeStyle="#0f0",a.strokeRect(f.x,f.y,f.w,f.h),a.stroke(),a.fillStyle="#ff0",a.beginPath(),a.arc(0,0,2,0,365),a.fill()}a.restore()},changeOrigin:function(a,b){var c,d,e,f;c=this.x,d=this.y;for(e in this.entities)f=this.entities[e],f.x-=-c+a,f.y-=-d+b;return this.x=a,this.y=b,this},destroy:function(){this._destroy=!0}},h.Group.prototype.tween=h.Sprite.prototype.tween,h.Group.prototype.prepareTween=h.Sprite.prototype.prepareTween,h.Label=function(){this.x=0,this.y=0,this.w=0,this.h=0,this.originX=0,this.originY=0,this.rotation=0,this.alpha=1,this.scaleX=1,this.scaleY=1,this.debugDrawing=!1,this._destroy=!1,this.font="Arial",this.size=12,this.style="",this.color="#000",this.strokeColor="#000",this.strokeWidth=0,this.strokeOver=!1,this.align="left",this.verticalAlign="top",this._measureCache=null},h.Label.prototype={update:function(){},draw:function(a){var b;if(a.save(),a.translate(this.x,this.y),this.rotation&&a.rotate(this.rotation*Math.PI/180),a.scale(this.scaleX,this.scaleY),a.font=this.size+'px "'+this.font+'" '+this.style,a.fillStyle=this.color,a.strokeStyle=this.strokeColor,a.lineWidth=this.strokeWidth,a.textAlign=this.align,a.textBaseline=this.verticalAlign,b=a.font+a.lineWidth+a.textAlign+a.textBaseline,this._measureCache!==b&&(this._measureCache=b,this.calculateDimensions(),this._asyncCenter&&(delete this._asyncCenter,this.centerOrigin())),this.strokeOver?(a.fillText(this.value,-this.originX,-this.originY),this.strokeWidth&&a.strokeText(this.value,-this.originX,-this.originY)):(this.strokeWidth&&a.strokeText(this.value,-this.originX,-this.originY),a.fillText(this.value,-this.originX,-this.originY)),this.debugDrawing){switch(a.beginPath(),a.strokeStyle="#0ff",a.lineWidth=1,this.align){case"right":a.strokeRect(-this.originX-this.w,-this.originY,this.w,this.h);break;case"center":a.strokeRect(-this.originX,-this.originY,this.w,this.h);break;case"left":a.strokeRect(-this.originX+this.w,-this.originY,this.w,this.h)}a.stroke(),a.fillStyle="#f0f",a.beginPath(),a.arc(0,0,2,0,365),a.fill()}a.restore()},centerOrigin:function(){return null===this._measureCache?(this._asyncCenter=!0,void 0):(console.log(this),this.changeOrigin(this.w/2,this.h/2),void 0)},calculateDimensions:function(a){var b;a||(b=document.createElement("canvas"),a=b.getContext("2d")),a.save(),a.font=this.size+'px "'+this.font+'" '+this.style,a.fillStyle=this.color,a.strokeStyle=this.strokeColor,a.lineWidth=this.strokeWidth,a.textAlign=this.align,a.textBaseline=this.verticalAlign,this.w=a.measureText(this.value).width,b=document.createElement("span"),b.style.fontFamily=this.font,b.style.fontStyle=this.style,b.style.verticalAlign=this.verticalAlign,b.style.fontSize=this.size+"px",b.style.padding=0,b.style.margin=0,b.innerHTML=this.value,document.body.appendChild(b),this.h=b.offsetHeight,document.body.removeChild(b),a.restore()}},h.Label.prototype.tween=h.Sprite.prototype.tween,h.Label.prototype.prepareTween=h.Sprite.prototype.prepareTween,h.Label.prototype.changeOrigin=h.Sprite.prototype.changeOrigin,h.Label.prototype.destroy=h.Sprite.prototype.destroy,h.TileGrid=function(a){var b=[[]];return a._isSpritemap&&(a={spritemaps:[a]}),b._spritemaps=a.spritemaps||[],b.width=0,b.height=0,b.x=0,b.y=0,b.alpha=1,b.originX=0,b.originY=0,b.rotation=0,b.scaleX=1,b.scaleY=1,b.gridSize=0,b.gridColor="#000",b._tilemap=a.tilemap,b._core=h,b._slice={x:0,y:0,w:0,h:0},this._destroy=!1,b._isTilegrid=!0,h.extend(b,h.TileGrid.prototype),a.width&&a.height&&b.resize(a.width,a.height),b},h.TileGrid.prototype={setData:function(a){var b;for(b=0;b<a.length;b++)this[b]=a[b]},setStream:function(a){var b,c,d;for(d=0,c=0;c<this.height;c++)for(b=0;b<this.width;b++)this[b][c]=a[d]?a[d]-1:null,d++},fill:function(a,b,c){void 0===b&&(c=a,a=0,b=0)},resize:function(a,b,c){var d,e;if(void 0===c&&(c=null),b>this[0].length)for(d=0;d<this.length;d++)for(e=this[d].length;b>e;e++)this[d][e]=c;if(a>this.length)for(d=this.length;a>d;d++)for(this[d]=[],e=0;b>e;e++)this[d].push(c);this.width=a,this.height=b},update:function(){},draw:function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;if(h=this._spritemaps[0][0].w,i=this._spritemaps[0][0].h,j=this.originX,k=this.originY,this.alpha){if(a.save(),a.translate(this.x,this.y),this.alpha<0&&(this.alpha=0),a.globalAlpha=this.alpha,this.rotation){for(;this.rotation>360;)this.rotation-=360;for(;this.rotation<0;)this.rotation+=360;a.rotate(this.rotation*Math.PI/180)}for(a.scale(this.scaleX,this.scaleY),d=-(this.x+(this._tilemap?this._tilemap.x:0))+this._core.camera.x,d=Math.floor(d/h),e=-(this.y+(this._tilemap?this._tilemap.y:0))+this._core.camera.y,e=Math.floor(e/i),f=Math.ceil(this._core.width()/h)+1,g=Math.ceil(this._core.height()/i)+1,this._slice.x=d,this._slice.y=e,this._slice.w=f,this._slice.h=g,b=d;d+f>b;b++)for(c=e;e+g>c;c++)if(l=this[b][c],null!==l){for(m=0;m<this._spritemaps.length;m++){if(l<this._spritemaps[m].length){n=this._spritemaps[m][l];break}l-=this._spritemaps[m].length}a.drawImage(n.image,n.x,n.y,h,i,-j+b*h,-k+c*i,h,i)}if(this.gridSize)for(a.strokeColor=this.gridColor,a.lineWidth=this.gridSize,b=1;b<this.length;b++)for(c=1;c<this[b].length;c++)a.beginPath(),a.moveTo(b*h+.5,0),a.lineTo(b*h+.5,this[b].length*i),a.stroke(),a.beginPath(),a.moveTo(0,c*i+.5),a.lineTo(this.length*h,c*i+.5),a.stroke();a.restore()}}},h.TileMap=function(a){this.x=0,this.y=0,this.originX=0,this.originY=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.alpha=1,this._destroy=!1,this._spritemaps=[],this.layer=[],this.width=0,this.height=0;var b,c;if(a){for(this.width=a.width,this.height=a.height,b=0;b<a.tilesets.length;b++)this._spritemaps.push(h.a[a.tilesets[b].key]);for(b=0;b<a.layers.length;b++)"tilelayer"===a.layers[b].type&&(c=this.createLayer(a.layers[b].width,a.layers[b].height),c.setStream(a.layers[b].data),a.layers[b].visible||(c.alpha=0))}},h.TileMap.prototype={createLayer:function(a,b,c,d){var e;return e=new h.TileGrid({tilemap:this,spritemaps:this._spritemaps,x:c||0,y:d||0,width:a||this.width,height:b||this.height}),this.layer.push(e),e},update:function(){},draw:function(a){a.save(),a.translate(this.x,this.y),a.rotate(this.rotation*Math.PI/180),a.scale(this.scaleX,this.scaleY);var b;for(b=0;b<this.layer.length;b++)this.layer[b].draw(a);a.restore()},getPath:function(a,b,c,d,e,f){function g(a,b,c,d){return Math.abs(c-a)+Math.abs(d-b)}function h(){var a;return _.sortBy(p,function(a){return a.g+a.h}),a=p.shift()}function i(a){void 0===q[a.x]&&(q[a.x]=[]),q[a.x][a.y]=!0}function j(a){return void 0===q[a.x]?!1:q[a.x][a.y]}function k(a){return _.find(p,function(b){return b.x===a.x&&b.y===a.y})}function l(a){var b;for(b=[];a.parent;)b.push({x:a.x,y:a.y}),a=a.parent;return b.push({x:a.x,y:a.y}),b.shift(),b}function m(a,d,e,h){0>a||0>d||d>=s||a>=t||q[a]&&q[a][d]||-1===f.indexOf(o[a][d])&&h.push({x:a,y:d,g:e.g+1,h:g(a,d,b,c)})}function n(a){var b,c,d,e,f,g;b=[],m(a.x,a.y-1,a,b),m(a.x-1,a.y,a,b),m(a.x+1,a.y,a,b),m(a.x,a.y+1,a,b);for(f in b)c=b[f],g=a.g+1,j(c)&&g>=c.g||(d=k(c),(!d||g<c.g)&&(e=!0,d||(d=c,e=!1),d.parent=a,d.g=g,e||p.push(d)))}var o,p,q,r,s,t;if(o=a instanceof Array?a:this.layer[a],f=f||[],p=[],q=[],t=o.length,s=o[0].length,f&&-1!==f.indexOf(o[d][e]))return[];for(p.push({x:d,y:e,g:0,h:g(d,e,b,c)});p.length;){if(r=h(),r.x===b&&r.y===c)return l(r);i(r),n(r)}return[]}};var j,k;h.Emitter=j=function(a){this.x=a.x,this.y=a.y,this.w=a.w,this.h=a.h,this.debug=a.debug,this.number=a.number||1,this.particles=[],this.spawnTime=a.spawnTime||1,this.assets=a.assets,this.rotation=a.rotation||0,this.rebirth=a.rebirth||1;var b=h.ifDef;this.particlePreset={minLife:a.life instanceof Array?a.life[0]:b(a.life,100),maxLife:a.life instanceof Array?a.life[1]:b(a.life,100),minInitDirection:a.direction instanceof Array?a.direction[0]:b(a.direction,0),maxInitDirection:a.direction instanceof Array?a.direction[1]:b(a.direction,0),minDirectionChange:a.directionChange instanceof Array?a.directionChange[0]:b(a.directionChange,0),maxDirectionChange:a.directionChange instanceof Array?a.directionChange[1]:b(a.directionChange,0),minTargetDirection:a.directionTarget instanceof Array?a.directionTarget[0]:b(a.directionTarget,0),maxTargetDirection:a.directionTarget instanceof Array?a.directionTarget[1]:b(a.directionTarget,0),minInitSpeed:a.speed instanceof Array?a.speed[0]:b(a.speed,1),maxInitSpeed:a.speed instanceof Array?a.speed[1]:b(a.speed,1),minSpeedChange:a.speedChange instanceof Array?a.speedChange[0]:b(a.speedChange,0),maxSpeedChange:a.speedChange instanceof Array?a.speedChange[1]:b(a.speedChange,0),minTargetSpeed:a.speedTarget instanceof Array?a.speedTarget[0]:b(a.speedTarget,0),maxTargetSpeed:a.speedTarget instanceof Array?a.speedTarget[0]:b(a.speedTarget,0),minInitScale:a.scale instanceof Array?a.scale[0]:b(a.scale,1),maxInitScale:a.scale instanceof Array?a.scale[1]:b(a.scale,1),minScaleChange:a.scaleChange instanceof Array?a.scaleChange[0]:b(a.scaleChange,0),maxScaleChange:a.scaleChange instanceof Array?a.scaleChange[1]:b(a.scaleChange,0),minTargetScale:a.scaleTarget instanceof Array?a.scaleTarget[0]:b(a.scaleTarget,0),maxTargetScale:a.scaleTarget instanceof Array?a.scaleTarget[0]:b(a.scaleTarget,0),minInitAlpha:a.alpha instanceof Array?a.alpha[0]:b(a.alpha,1),maxInitAlpha:a.alpha instanceof Array?a.alpha[1]:b(a.alpha,1),minAlphaChange:a.alphaChange instanceof Array?a.alphaChange[0]:b(a.alphaChange,0),maxAlphaChange:a.alphaChange instanceof Array?a.alphaChange[1]:b(a.alphaChange,0),minTargetAlpha:a.alphaTarget instanceof Array?a.alphaTarget[0]:b(a.alphaTarget,0),maxTargetAlpha:a.alphaTarget instanceof Array?a.alphaTarget[0]:b(a.alphaTarget,0),fadeInValue:a.fadeInValue||1,fadeOutValue:a.fadeOutValue||1};for(var c=this,d=0;d<this.number;d++)setTimeout(function(){var a=new k(c);c.particles.push(a)},h.randomInRange(0,this.spawnTime))},j.prototype={update:function(){for(var a=0;a<this.particles.length;a++)this.particles[a].update()},draw:function(a){if(a.save(),this.rotation){for(;this.rotation>360;)this.rotation-=360;for(;this.rotation<0;)this.rotation+=360;a.rotate(this.rotation*Math.PI/180)}this.debug&&(a.fillStyle="#f00",a.strokeStyle="#f00",a.strokeRect(this.x,this.y,this.w,this.h));for(var b=0;b<this.particles.length;b++)this.particles[b].draw(a);a.restore()},recycle:function(a){var b,c=this.particlePreset;b=this.assets[Math.round(h.randomInRange(0,this.assets.length-1))],b instanceof String&&(b=h.a[b]),a.setAsset(b),a.w=b.w,a.h=b.h,a.fadeInValue=c.fadeInValue,a.fadeOutValue=c.fadeOutValue,a.birth=!0,a.scaleX=a.scaleY=h.randomInRange(c.minInitScale,c.maxInitScale),a.scaleChange=h.randomInRange(c.minScaleChange,c.maxScaleChange),a.targetScale=h.randomInRange(c.minTargetScale,c.maxTargetScale),a.alpha=h.randomInRange(c.minInitAlpha,c.maxInitAlpha),a.alphaChange=h.randomInRange(c.minAlphaChange,c.maxAlphaChange),a.targetAlpha=h.randomInRange(c.minTargetAlpha,c.maxTargetAlpha),a.life=h.randomInRange(c.minLife,c.maxLife),a.x=h.randomInRange(this.x,this.x+this.w),a.y=h.randomInRange(this.y,this.y+this.h),a.direction=h.randomInRange(c.minInitDirection,c.maxInitDirection),a.directionChange=h.randomInRange(c.minDirectionChange,c.maxDirectionChange),a.targetDirection=h.randomInRange(c.minTargetDirection,c.maxTargetDirection),a.speed=h.randomInRange(c.minInitSpeed,c.maxInitSpeed),a.speedChange=h.randomInRange(c.minSpeedChange,c.maxSpeedChange),a.targetSpeed=h.randomInRange(c.minTargetSpeed,c.maxTargetSpeed)}},h.Particle=k=function(a){this.emitter=a,this.rebirth=a.rebirth,this.assets=a.assets,h.Sprite.call(this,{}),this.stretch=!0,a.recycle(this)},k.prototype=h.extend(h.Sprite.prototype,{update:function(){return this.direction+=h.randomInRange(-2,2),this.birth&&this.life>0&&this.alpha<this.targetAlpha&&(this.alpha+=this.fadeInValue,this.alpha>this.targetAlpha&&(this.alpha=this.targetAlpha,this.birth=!1)),0!==this.scaleChange&&this.scaleX!==this.targetScale&&(this.scaleX=this.scaleY+=this.scaleChange,(this.scaleChange>0?this.scaleX>this.targetScale:this.scaleX<this.targetScale)&&(this.scaleX=this.scaleY=this.targetScale,this.scaleChange=0)),0!==this.alphaChange&&this.alpha!==this.targetAlpha&&(this.alpha+=this.alphaChange,(this.alphaChange>0?this.alpha>this.targetAlpha:this.alpha<this.targetAlpha)&&(this.alpha=this.targetAlpha,this.alphaChange=0)),0!==this.directionChange&&this.direction!==this.targetDirection&&(this.direction+=this.directionChange,(this.directionChange>0?this.direction>this.targetDirection:this.direction<this.targetDirection)&&(this.direction=this.targetDirection,this.directionChange=0)),0!==this.speedChange&&this.speed!==this.targetSpeed&&(this.speed+=this.speedChange,(this.speedChange>0?this.speed<this.targetSpeed:this.speed>this.targetSpeed)&&(this.speed=this.targetSpeed,this.speedChange=0)),this.life<=0?this.alpha>0?(this.alpha-=this.fadeOutValue,void 0):((1===this.rebirth||h.random()<this.rebirth)&&this.emitter.recycle(this),void 0):(this.life--,void 0)}});var m,n,o,p,q,r;q={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"escape",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",91:"win",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock",186:";",187:"+",188:",",189:"-",190:".",191:"/",192:"`",219:"(",220:"^",221:"´",222:"`",226:"\\"};var s,t,u;h.PointerArea=function(){e(h),this.x=0,this.y=0,this.w=h.width(),this.h=h.height(),this.originX=0,this.originY=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this._attachedEvents={},this.debugDrawing=!1,this.disabled=!1},h.PointerArea.prototype={draw:function(a){this.debugDrawing&&(a.save(),a.translate(this.x,this.y),this.rotation&&a.rotate(this.rotation*Math.PI/180),a.scale(this.scaleX,this.scaleY),a.beginPath(),a.strokeStyle="#a584ac",a.rect(0,0,this.w,this.h),a.stroke(),a.restore())},update:function(){},shadowDraw:function(a,b,c){if(!(this instanceof h.Sprite&&void 0===this.disabled||this instanceof h.PointerArea&&void 0===this._attachedEvents[c])){var d;if(r.save(),r.translate(this.x,this.y),this.rotation&&r.rotate(this.rotation*Math.PI/180),r.scale(this.scaleX,this.scaleY),this instanceof h.Sprite&&!this._captureBoundingBox&&(r.drawImage(this.asset,-this.originX,-this.originY),g(a,b)))for(d in this._attachedEvents[c])this._attachedEvents[c][d].resolve(a,b);
if((this instanceof h.PointerArea||this._captureBoundingBox)&&(r.beginPath(),r.fillRect(-this.originX,-this.originY,this.w,this.h),r.fill(),g(a,b)))for(d in this._attachedEvents[c])this._attachedEvents[c][d].resolve(a,b);if(this instanceof h.Group)for(d in this.entities)this.entities[d].shadowDraw(a,b,c);r.restore()}},on:function(a){void 0===this._attachedEvents[a]&&(this._attachedEvents[a]=[]);var b;switch(b=new h.Promise,a){case"pointerdown":s=!0;break;case"pointerup":t=!0;break;case"pointermove":u=!0}return this._attachedEvents[a].push(b),b}},h.Sprite.prototype.shadowDraw=h.PointerArea.prototype.shadowDraw,h.Group.prototype.shadowDraw=h.PointerArea.prototype.shadowDraw,h.Sprite.prototype.pointerEnable=function(a){e(this._core),this._captureBoundingBox=a,this._attachedEvents={},this.disabled=!1,this.on=h.PointerArea.prototype.on},h.onKey=function(a){var b;return d(),b=new h.Promise,void 0===o[a]&&(o[a]=[]),o[a].push(b),b},h.isPressed=function(a){return p?!!p[a]:!1},h.initializeKeyboard=function(){d()},h.extend(h,new h.Core),setTimeout(function(){h.loadMainModule!==!1&&h.fetchModules("main")},0)}();